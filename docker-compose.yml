services:
  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: lucy_docker_socket_proxy
    restart: unless-stopped
    environment:
      - POST=1
      - CONTAINERS=0
      - ALLOW_START=1
      - ALLOW_STOP=1
      - ALLOW_RESTARTS=1
      - INFO=1
      - VERSION=1
      - PING=1
      - EXEC=0
      - IMAGES=0
      - NETWORKS=0
      - VOLUMES=0
      - AUTH=0
      - SECRETS=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "127.0.0.1:2375:2375"
    networks:
      - lucy_internal

  # ----------------------------------------------------------------
  # CEREBRO: n8n (Orquestador)
  # Modo: Host (Acceso total a la red del host)
  # ----------------------------------------------------------------
  n8n:
    image: n8nio/n8n:2.4.4
    container_name: lucy_brain_n8n
    user: "0:0"
    network_mode: "host" # CLAVE: Elimina overhead de NAT y bridge
    restart: unless-stopped
    depends_on:
      - socket-proxy
    environment:
      - DOCKER_HOST=tcp://127.0.0.1:2375
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_TEMPLATES_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_LISTEN_ADDRESS=127.0.0.1
      - N8N_DIAGNOSTICS_CONFIG_BACKEND=
      - N8N_DIAGNOSTICS_CONFIG_FRONTEND=
      - EXTERNAL_FRONTEND_HOOKS_URLS=
      - N8N_METRICS=true
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_AUTH_TOKEN=lucy-local-runner-token
      - N8N_PYTHON_ENABLED=false
      - GENERIC_TIMEZONE=America/Argentina/Buenos_Aires
      - N8N_RESTRICT_FILE_ACCESS_TO=/data/lucy_ipc;/home/node/.n8n-files
      - ANTIGRAVITY_URL=http://127.0.0.1:5000
      - LUCY_IPC_INBOX=/data/lucy_ipc/inbox
      - LUCY_IPC_DEADLETTER=/data/lucy_ipc/deadletter
      - NODE_FUNCTION_ALLOW_BUILTIN=fs,path,crypto
      # Seguridad: n8n corre como root dentro del container para acceder a archivos del host
      # (Se puede ajustar PUID/PGID si es necesario, pero host mode simplifica esto)
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workspace:/data/workspace:rw # Intercambio con Antigravity
      - ./ipc:/data/lucy_ipc:rw # RAM Disk para IPC
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:5678/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 12

  runners:
    image: n8nio/runners@sha256:d19d15e4820b6a85ed5e9e0d62cdfec4b9b4e879516a5be4424e6bbd4796bafb
    container_name: lucy_brain_runners
    network_mode: "host"
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    command: ["javascript"]
    environment:
      - N8N_RUNNERS_AUTH_TOKEN=lucy-local-runner-token
      - N8N_RUNNERS_TASK_BROKER_URI=http://127.0.0.1:5679
    volumes:
      - ./config/n8n-task-runners.json:/etc/n8n-task-runners.json:ro
      - ./ipc:/data/lucy_ipc:rw
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:5680/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 12

  # ----------------------------------------------------------------
  # MEMORIA: Qdrant (Base Vectorial)
  # Modo: Bridge (Accesible vía localhost:6333)
  # ----------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant@sha256:0425e3e03e7fd9b3dc95c4214546afe19de2eb2e28ca621441a56663ac6e1f46
    container_name: lucy_memory_qdrant
    restart: unless-stopped
    ports:
      - "127.0.0.1:6333:6333" # Solo expuesto a localhost por seguridad
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - lucy_internal

  # ----------------------------------------------------------------
  # MEMORIA RÁPIDA: Redis (Cola y Estado)
  # Modo: Bridge
  # ----------------------------------------------------------------
  redis:
    image: redis@sha256:6cbef353e480a8a6e7f10ec545f13d7d3fa85a212cdcc5ffaf5a1c818b9d3798
    container_name: lucy_memory_redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    networks:
      - lucy_internal

  # ----------------------------------------------------------------
  # OJOS: SearXNG (Búsqueda Privada)
  # Modo: Bridge
  # ----------------------------------------------------------------
  searxng:
    image: searxng/searxng@sha256:9c071b8685d6586692072df2eaa48a0adb8e53d13e18cb53e21924837c5803d7
    container_name: lucy_eyes_searxng
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:8081/
    volumes:
      - ./data/searxng:/etc/searxng
    networks:
      - lucy_internal
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # ----------------------------------------------------------------
  # MANOS (VIRTUALES): Antigravity (Sandbox de Ejecución)
  # Modo: Isolated Bridge (Sin internet)
  # Nota: Usamos una imagen local construida desde ./antigravity
  # ----------------------------------------------------------------
  antigravity:
    build: ./antigravity
    image: lucy_antigravity:local
    container_name: lucy_hands_antigravity
    user: "0:0"
    networks:
      - antigravity_isolated
      - antigravity_host
    ports:
      - "127.0.0.1:5000:5000" # API accesible solo desde host (n8n)
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=128m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      - ANTIGRAVITY_DEFAULT_TIMEOUT_S=30
      - ANTIGRAVITY_MAX_TIMEOUT_S=30
    volumes:
      - ./workspace:/workspace:rw # Volumen compartido para entregar artefactos
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G # Limite estricto para evitar congelamientos
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/healthz', timeout=2)\" || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 12

  lucy_ui_panel:
    build: ./apps/lucy_panel
    image: lucy_ui_panel:local
    container_name: lucy_ui_panel
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    network_mode: "host"
    command: ["uvicorn", "app.main:app", "--host", "127.0.0.1", "--port", "5100"]
    environment:
      - GATEWAY_URL=http://127.0.0.1:5678/webhook/lucy-input
      - IPC_ROOT=/data/lucy_ipc
      - REPO_ROOT=/repo
    volumes:
      - ./ipc:/data/lucy_ipc:ro
      - ./:/repo:rw
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:5100/', timeout=2)\" || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 12

  prometheus:
    image: prom/prometheus:v3.5.0
    container_name: lucy_obs_prometheus
    network_mode: "host"
    restart: unless-stopped
    profiles: ["observability"]
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.listen-address=127.0.0.1:9090
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./data/prometheus:/prometheus

networks:
  lucy_internal:
    driver: bridge
  antigravity_isolated:
    driver: bridge
    internal: true # Bloqueo total de salida a internet
  antigravity_host:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
